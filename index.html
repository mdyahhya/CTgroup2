<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmileTracker - Daily Login Rewards</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Face-api.js library -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/dist/face-api.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        .container {
            width: 100vw;
            max-width: 375px;
            height: 100vh;
            max-height: 770px;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
            border-radius: 0;
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Daily Quote Section */
        .daily-quote {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            margin: 16px;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .daily-quote h3 {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .daily-quote p {
            color: white;
            font-size: 12px;
            line-height: 1.4;
            font-style: italic;
        }

        /* Navigation */
        nav {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-brand i {
            color: #ffd700;
            font-size: 18px;
        }

        .nav-brand h1 {
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .nav-stats {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .coin-display {
            background: rgba(255, 215, 0, 0.2);
            padding: 6px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .coin-display i {
            color: #ffd700;
            font-size: 12px;
        }

        .coin-display span {
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Smile Recognition Section */
        .main-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .section h2 {
            color: white;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Video Container */
        .video-container {
            position: relative;
            margin-bottom: 16px;
            border-radius: 8px;
            overflow: hidden;
        }

        #smileVideo {
            width: 100%;
            height: 250px;
            background: black;
            border-radius: 8px;
        }

        #smileCanvas {
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 8px;
        }

        /* Login Status */
        .login-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .login-card.completed {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
        }

        .login-card h4 {
            color: white;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .login-card p {
            color: #d1d5db;
            font-size: 10px;
        }

        .login-card.completed p {
            color: #10b981;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .btn {
            padding: 10px 16px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: #3b82f6; }
        .btn-primary:hover:not(:disabled) { background: #2563eb; }
        
        .btn-success { background: #10b981; }
        .btn-success:hover:not(:disabled) { background: #059669; }

        .btn-danger { background: #ef4444; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }

        .btn-warning { background: #f59e0b; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }

        /* Progress Section */
        .progress-section {
            margin-top: 16px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: white;
            font-size: 12px;
            text-align: center;
        }

        /* Gift Buttons */
        .gift-section {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-top: 16px;
        }

        .gift-section h3 {
            color: #ffd700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .gift-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .gift-btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1f2937;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .gift-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .gift-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* PWA Install Popup */
        .pulse-ring {
            animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(2.4);
                opacity: 0;
            }
        }

        /* Message Container */
        #messageContainer {
            position: fixed;
            top: 80px;
            right: 16px;
            z-index: 50;
            max-width: 280px;
        }

        .message {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            color: white;
            font-size: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .message.success { background: #10b981; }
        .message.error { background: #ef4444; }
        .message.warning { background: #f59e0b; }
        .message.info { background: #3b82f6; }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .loading-content p {
            color: white;
            font-size: 14px;
            margin-top: 12px;
        }

        #loadingProgress {
            color: #d1d5db;
            font-size: 12px;
            margin-top: 8px;
        }

        /* PWA Install Styles */
        #install-popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .install-popup {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 12px;
            max-width: 300px;
            margin: 16px;
        }

        .install-popup h3 {
            color: white;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .install-popup p {
            color: #d1d5db;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .install-buttons {
            display: flex;
            gap: 8px;
        }

        .install-buttons button {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        #installConfirm {
            background: #3b82f6;
        }

        #installConfirm:hover {
            background: #2563eb;
        }

        /* Install button */
        #install-button-container {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 40;
        }

        #install-button-container button {
            background: #3b82f6;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        #install-button-container button:hover {
            background: #2563eb;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        /* Responsive adjustments */
        @media (max-width: 375px) {
            .container {
                max-width: 100vw;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Screen -->
        <div id="loadingScreen">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>Loading AI Models...</p>
                <p id="loadingProgress">Initializing...</p>
            </div>
        </div>

        <!-- Daily Quote -->
        <div class="daily-quote">
            <h3><i class="fas fa-quote-left"></i> Daily Inspiration</h3>
            <p id="dailyQuote">A smile is the universal welcome. Keep smiling and make the world brighter!</p>
        </div>

        <!-- Navigation -->
        <nav class="glass-effect">
            <div class="nav-container">
                <div class="nav-brand">
                    <i class="fas fa-smile-beam"></i>
                    <h1>SmileTracker</h1>
                </div>
                
                <div class="nav-stats">
                    <div class="coin-display">
                        <i class="fas fa-coins"></i>
                        <span id="coinCount">0</span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Smile Recognition Section -->
            <div class="section">
                <h2>
                    <i class="fas fa-smile"></i>Smile Detection
                </h2>
                
                <!-- Login Status -->
                <div class="login-status">
                    <div class="login-card" id="morningLogin">
                        <h4>Morning Login</h4>
                        <p id="morningStatus">Available until 8 AM</p>
                    </div>
                    <div class="login-card" id="eveningLogin">
                        <h4>Evening Login</h4>
                        <p id="eveningStatus">Available after 8 PM</p>
                    </div>
                </div>
                
                <div class="video-container">
                    <video id="smileVideo" autoplay muted></video>
                    <canvas id="smileCanvas"></canvas>
                </div>
                
                <div class="button-group">
                    <button id="startCamera" class="btn btn-primary">
                        <i class="fas fa-video"></i>Start Camera
                    </button>
                    <button id="stopCamera" class="btn btn-danger" disabled>
                        <i class="fas fa-stop"></i>Stop Camera
                    </button>
                </div>
                
                <div id="smileStatus" class="text-center" style="color: white; margin-bottom: 16px;">
                    Ready to detect your smile!
                </div>
            </div>

            <!-- Progress Section -->
            <div class="section progress-section">
                <h2><i class="fas fa-trophy"></i>Progress</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0 / 20 coins collected</div>
                
                <div style="margin-top: 12px; color: white; font-size: 12px; text-align: center;">
                    <p>Daily Streak: <span id="streakCount">0</span> days</p>
                    <p>Next Gift in: <span id="daysToGift">10</span> days</p>
                </div>
            </div>

            <!-- Gift Section -->
            <div class="gift-section">
                <h3><i class="fas fa-gift"></i>Continental Group Rewards</h3>
                <div class="gift-buttons">
                    <button class="gift-btn" id="gift1Btn" disabled onclick="openGift('gift1.html')">
                        <i class="fas fa-gift"></i>
                        Tech Gift #1 (20 coins + 10 days streak)
                    </button>
                    <button class="gift-btn" id="gift2Btn" disabled onclick="openGift('gift2.html')">
                        <i class="fas fa-star"></i>
                        Tech Gift #2 (Next reward)
                    </button>
                </div>
                
                <!-- Testing Button (Remove in production) -->
                <div style="margin-top: 12px;">
                    <button class="btn btn-warning" id="testGiftBtn" onclick="testGiftUnlock()">
                        <i class="fas fa-flask"></i>Test Gift Unlock (1 coin)
                    </button>
                </div>
            </div>
        </div>

        <!-- Install PWA Popup -->
        <div id="install-popup-overlay" class="hidden">
            <div class="install-popup">
                <h3>Install SmileTracker</h3>
                <p>Install this app on your device for quick access and offline functionality.</p>
                <div class="install-buttons">
                    <button id="installConfirm">
                        <i class="fas fa-download" style="margin-right: 4px;"></i>Install
                    </button>
                    <button onclick="hideInstallPopup()" style="background: #6b7280;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Install Button -->
        <div id="install-button-container" class="hidden">
            <button onclick="showInstallPopup()" class="pulse-ring">
                <i class="fas fa-download"></i>
            </button>
        </div>

        <!-- Success/Error Messages -->
        <div id="messageContainer"></div>
    </div>

    <script>
        // Global Variables
        let isModelsLoaded = false;
        let videoStream = null;
        let detectionInterval = null;
        let lastSmileTime = 0;
        let smileCount = 0;
        let isSmiling = false;
        let userCoins = parseInt(localStorage.getItem('userCoins') || '0');
        let userStreak = parseInt(localStorage.getItem('userStreak') || '0');
        let lastLoginDate = localStorage.getItem('lastLoginDate');
        let todayLogins = JSON.parse(localStorage.getItem('todayLogins') || '{}');

        // Daily Quotes Array
        const dailyQuotes = [
            "A smile is the universal welcome. Keep smiling and make the world brighter! ðŸ˜Š",
            "Smile, it's the key that fits the lock of everybody's heart. ðŸ’",
            "A smile is happiness you'll find right under your nose. ðŸŒŸ",
            "Every smile makes you a day younger and brings joy to others. âœ¨",
            "Smiling is contagious - spread the joy wherever you go! ðŸŒˆ",
            "Your smile is your logo, your personality is your business card. ðŸ’«",
            "Life is better when you're laughing and smiling! ðŸŽ‰",
            "A genuine smile comes from within and lights up the world. ðŸŒž",
            "Smile at strangers and you just might change a life. ðŸŒ¸",
            "The world always looks brighter from behind a smile. ðŸŒ…"
        ];

        // PWA Installation Variables
        let deferredPrompt;

        // PWA Event Listeners
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!isAppInstalled()) {
                toggleInstallButton();
            }
        });

        document.getElementById('installConfirm').addEventListener('click', async () => {
            hideInstallPopup();
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    markInstallAttempted();
                }
                deferredPrompt = null;
            }
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Initialize Face-api models
        async function loadModels() {
            const loadingProgress = document.getElementById('loadingProgress');
            
            try {
                loadingProgress.textContent = 'Loading face detection model...';
                await faceapi.nets.ssdMobilenetv1.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/model');
                
                loadingProgress.textContent = 'Loading face landmarks model...';
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/model');
                
                loadingProgress.textContent = 'Loading face expression model...';
                await faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/model');
                
                loadingProgress.textContent = 'Models loaded successfully!';
                isModelsLoaded = true;
                
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    initializeApp();
                }, 1000);
                
            } catch (error) {
                console.error('Error loading models:', error);
                loadingProgress.textContent = 'Error loading models. Please refresh.';
            }
        }

        // Initialize App
        function initializeApp() {
            updateDailyQuote();
            updateUI();
            updateLoginStatus();
            checkStreakReset();
            toggleInstallButton();
        }

        // Update Daily Quote
        function updateDailyQuote() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const quoteIndex = dayOfYear % dailyQuotes.length;
            document.getElementById('dailyQuote').textContent = dailyQuotes[quoteIndex];
        }

        // Camera Controls
        document.getElementById('startCamera').addEventListener('click', startCamera);
        document.getElementById('stopCamera').addEventListener('click', stopCamera);

        async function startCamera() {
            if (!isModelsLoaded) {
                showMessage('AI models are still loading. Please wait...', 'warning');
                return;
            }

            try {
                const video = document.getElementById('smileVideo');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                video.srcObject = stream;
                videoStream = stream;
                
                video.addEventListener('loadedmetadata', () => {
                    const canvas = document.getElementById('smileCanvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                });
                
                document.getElementById('startCamera').disabled = true;
                document.getElementById('stopCamera').disabled = false;
                
                // Start smile detection
                detectionInterval = setInterval(detectSmile, 100); // Check every 100ms for better accuracy
                
                showMessage('Camera started! Show your beautiful smile! ðŸ˜Š', 'success');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                showMessage('Error accessing camera. Please check permissions.', 'error');
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            document.getElementById('startCamera').disabled = false;
            document.getElementById('stopCamera').disabled = true;
            
            const canvas = document.getElementById('smileCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            document.getElementById('smileStatus').textContent = 'Camera stopped. Ready to detect your smile!';
            
            showMessage('Camera stopped.', 'info');
        }

        // Smile Detection Function
        async function detectSmile() {
            const video = document.getElementById('smileVideo');
            const canvas = document.getElementById('smileCanvas');
            const ctx = canvas.getContext('2d');
            const statusDiv = document.getElementById('smileStatus');

            if (!video.videoWidth || !video.videoHeight) return;

            try {
                const detections = await faceapi
                    .detectAllFaces(video)
                    .withFaceLandmarks()
                    .withFaceExpressions();

                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (detections.length === 0) {
                    statusDiv.textContent = 'No face detected. Please position your face in the camera.';
                    statusDiv.style.color = '#f59e0b';
                    isSmiling = false;
                    return;
                }

                if (detections.length > 1) {
                    statusDiv.textContent = 'Multiple faces detected. Please ensure only one person is in frame.';
                    statusDiv.style.color = '#f59e0b';
                    isSmiling = false;
                    return;
                }

                const detection = detections[0];
                const { x, y, width, height } = detection.detection.box;
                
                // Draw face detection box
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, width, height);
                
                // Get smile confidence (happy expression)
                const expressions = detection.expressions;
                const smileConfidence = expressions.happy;
                const smileThreshold = 0.7; // 70% confidence threshold

                // Update status based on smile detection
                if (smileConfidence > smileThreshold) {
                    if (!isSmiling) {
                        isSmiling = true;
                        const now = Date.now();
                        
                        // Prevent rapid multiple detections (minimum 2 seconds between smiles)
                        if (now - lastSmileTime > 2000) {
                            lastSmileTime = now;
                            handleSmileDetected();
                        }
                    }
                    
                    statusDiv.innerHTML = `ðŸ˜Š Great Smile! Confidence: ${Math.round(smileConfidence * 100)}%`;
                    statusDiv.style.color = '#10b981';
                    
                    // Draw smile indicator
                    ctx.fillStyle = '#10b981';
                    ctx.fillText('ðŸ˜Š SMILE!', x, y - 10);
                    
                } else {
                    isSmiling = false;
                    statusDiv.innerHTML = `Keep smiling! Confidence: ${Math.round(smileConfidence * 100)}% (Need 70%+)`;
                    statusDiv.style.color = '#3b82f6';
                }

            } catch (error) {
                console.error('Smile detection error:', error);
                statusDiv.textContent = 'Error detecting smile. Please try restarting the camera.';
                statusDiv.style.color = '#ef4444';
            }
        }

        // Handle Smile Detection
        function handleSmileDetected() {
            const now = new Date();
            const currentHour = now.getHours();
            const today = now.toDateString();
            
            // Reset today's logins if it's a new day
            if (lastLoginDate !== today) {
                todayLogins = {};
                lastLoginDate = today;
                localStorage.setItem('lastLoginDate', today);
            }

            let loginType = '';
            let canLogin = false;

            // Check if it's morning login time (before 8 AM)
            if (currentHour < 8 && !todayLogins.morning) {
                loginType = 'morning';
                canLogin = true;
                todayLogins.morning = true;
                document.getElementById('morningLogin').classList.add('completed');
                document.getElementById('morningStatus').textContent = 'âœ“ Completed';
                
            // Check if it's evening login time (after 8 PM)
            } else if (currentHour >= 20 && !todayLogins.evening) {
                loginType = 'evening';
                canLogin = true;
                todayLogins.evening = true;
                document.getElementById('eveningLogin').classList.add('completed');
                document.getElementById('eveningStatus').textContent = 'âœ“ Completed';
            }

            if (canLogin) {
                // Award coins
                userCoins += 2;
                
                // Update streak if both logins completed today
                if (todayLogins.morning && todayLogins.evening) {
                    userStreak += 1;
                    showMessage(`ðŸŽ‰ Daily challenge complete! +2 coins. Streak: ${userStreak} days`, 'success');
                } else {
                    showMessage(`ðŸ˜Š ${loginType === 'morning' ? 'Morning' : 'Evening'} smile logged! +2 coins`, 'success');
                }
                
                // Save data
                localStorage.setItem('userCoins', userCoins.toString());
                localStorage.setItem('userStreak', userStreak.toString());
                localStorage.setItem('todayLogins', JSON.stringify(todayLogins));
                
                // Update UI
                updateUI();
                checkGiftEligibility();
                
            } else {
                if (currentHour >= 8 && currentHour < 20) {
                    showMessage('Evening login is available after 8 PM!', 'warning');
                } else if (todayLogins[loginType]) {
                    showMessage(`You've already completed your ${loginType} login today!`, 'warning');
                }
            }
        }

        // Update UI
        function updateUI() {
            document.getElementById('coinCount').textContent = userCoins;
            document.getElementById('streakCount').textContent = userStreak;
            
            const progress = (userCoins % 20) / 20 * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${userCoins % 20} / 20 coins collected`;
            
            const daysToNextGift = Math.max(0, 10 - userStreak);
            document.getElementById('daysToGift').textContent = daysToNextGift;
        }

        // Update Login Status
        function updateLoginStatus() {
            const now = new Date();
            const currentHour = now.getHours();
            const today = now.toDateString();
            
            // Reset if new day
            if (lastLoginDate !== today) {
                todayLogins = {};
            }

            // Update morning login status
            const morningCard = document.getElementById('morningLogin');
            const morningStatus = document.getElementById('morningStatus');
            
            if (todayLogins.morning) {
                morningCard.classList.add('completed');
                morningStatus.textContent = 'âœ“ Completed';
            } else if (currentHour >= 8) {
                morningStatus.textContent = 'Missed (until 8 AM)';
                morningStatus.style.color = '#ef4444';
            } else {
                morningStatus.textContent = 'Available until 8 AM';
            }

            // Update evening login status
            const eveningCard = document.getElementById('eveningLogin');
            const eveningStatus = document.getElementById('eveningStatus');
            
            if (todayLogins.evening) {
                eveningCard.classList.add('completed');
                eveningStatus.textContent = 'âœ“ Completed';
            } else if (currentHour >= 20) {
                eveningStatus.textContent = 'Available now!';
                eveningStatus.style.color = '#10b981';
            } else {
                eveningStatus.textContent = 'Available after 8 PM';
            }
        }

        // Check Gift Eligibility
        function checkGiftEligibility() {
            // Gift 1: 20 coins + 10 days streak
            if (userCoins >= 20 && userStreak >= 10) {
                document.getElementById('gift1Btn').disabled = false;
                showMessage('ðŸŽ Congratulations! Gift #1 is now available!', 'success');
            }
            
            // Gift 2: After first gift + another 10 days
            // This logic can be customized based on your requirements
        }

        // Check Streak Reset
        function checkStreakReset() {
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (lastLoginDate && lastLoginDate !== now.toDateString() && lastLoginDate !== yesterday.toDateString()) {
                // Streak broken - reset
                userStreak = 0;
                localStorage.setItem('userStreak', '0');
                showMessage('Streak reset! Remember to login daily to maintain your streak.', 'warning');
            }
        }

        // Gift Functions
        function openGift(giftPage) {
            window.location.href = giftPage;
        }

        // Testing Function (Comment: Change userCoins >= 1 to userCoins >= 20 and userStreak >= 10 for production)
        function testGiftUnlock() {
            if (userCoins >= 1) { // Testing with 1 coin - change to 20 for production
                document.getElementById('gift1Btn').disabled = false;
                showMessage('ðŸ§ª Test mode: Gift #1 unlocked with 1 coin!', 'warning');
            } else {
                showMessage('Not enough coins for testing. Earn at least 1 coin.', 'error');
            }
        }

        // Message System
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageEl = document.createElement('div');
            
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            
            container.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        // PWA Functions
        function showInstallPopup() {
            markInstallAttempted();
            document.getElementById('install-popup-overlay').classList.remove('hidden');
        }

        function hideInstallPopup() {
            document.getElementById('install-popup-overlay').classList.add('hidden');
        }

        function isAppInstalled() {
            if (localStorage.getItem('pwa-install-attempted') === 'true') {
                return true;
            }
            
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return true;
            }
            
            if (window.navigator.standalone === true) {
                return true;
            }
            
            return false;
        }

        function markInstallAttempted() {
            try {
                localStorage.setItem('pwa-install-attempted', 'true');
            } catch (e) {
                console.log('Could not save install state');
            }
        }

        function toggleInstallButton() {
            const installContainer = document.getElementById('install-button-container');
            
            if (isAppInstalled()) {
                installContainer.classList.add('hidden');
                return;
            }
            
            installContainer.classList.remove('hidden');
        }

        // Event Listeners
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                hideInstallPopup();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            if (detectionInterval) {
                clearInterval(detectionInterval);
            }
        });

        // Initialize app when page loads
        window.addEventListener('load', () => {
            loadModels();
        });
    </script>
</body>
</html>
